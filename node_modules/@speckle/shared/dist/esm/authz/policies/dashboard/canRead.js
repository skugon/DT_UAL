import { err, ok } from 'true-myth/result';
import { DashboardNotFoundError, WorkspaceNotEnoughPermissionsError } from '../../domain/authErrors.js';
import { ensureDashboardsEnabledFragment, ensureWorkspaceDashboardsFeatureAccessFragment } from '../../fragments/dashboards.js';
import { hasMinimumWorkspaceRole } from '../../checks/workspaceRole.js';
import { Roles } from '../../../core/constants.js';
import { checkIfAdminOverrideEnabledFragment, ensureMinimumServerRoleFragment } from '../../fragments/server.js';
export const canReadDashboardPolicy = (loaders) => async ({ userId, dashboardId }) => {
    const ensuredServerRole = await ensureMinimumServerRoleFragment(loaders)({
        userId,
        role: Roles.Server.User
    });
    if (ensuredServerRole.isErr)
        return err(ensuredServerRole.error);
    const isDashboardsEnabled = await ensureDashboardsEnabledFragment(loaders)({});
    if (isDashboardsEnabled.isErr)
        return err(isDashboardsEnabled.error);
    const dashboard = await loaders.getDashboard({ dashboardId });
    if (!dashboard)
        return err(new DashboardNotFoundError());
    const { workspaceId } = dashboard;
    const ensuredFeatureAccess = await ensureWorkspaceDashboardsFeatureAccessFragment(loaders)({ workspaceId });
    if (ensuredFeatureAccess.isErr)
        return err(ensuredFeatureAccess.error);
    const hasAdminAccess = await checkIfAdminOverrideEnabledFragment(loaders)({
        userId
    });
    if (hasAdminAccess.isOk && hasAdminAccess.value)
        return ok();
    const isWorkspaceMember = await hasMinimumWorkspaceRole(loaders)({
        userId: userId,
        workspaceId,
        role: Roles.Workspace.Member
    });
    if (!isWorkspaceMember)
        return err(new WorkspaceNotEnoughPermissionsError());
    return ok();
};
//# sourceMappingURL=canRead.js.map