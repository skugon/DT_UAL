"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.canLoadPolicy = void 0;
const result_1 = require("true-myth/result");
const constants_js_1 = require("../../../core/constants.js");
const projects_js_1 = require("../../fragments/projects.js");
const authErrors_js_1 = require("../../domain/authErrors.js");
const server_js_1 = require("../../fragments/server.js");
const canLoadPolicy = (loaders) => async ({ userId, projectId }) => {
    if (publiclyLoadableProjects.includes(projectId)) {
        return (0, result_1.ok)();
    }
    const hasAdminAccess = await (0, server_js_1.checkIfAdminOverrideEnabledFragment)(loaders)({
        userId
    });
    if (hasAdminAccess.isOk && hasAdminAccess.value) {
        return (0, result_1.ok)();
    }
    const ensuredWriteAccess = await (0, projects_js_1.ensureImplicitProjectMemberWithWriteAccessFragment)(loaders)({
        userId,
        projectId,
        role: constants_js_1.Roles.Stream.Contributor
    });
    if (ensuredWriteAccess.isErr) {
        if (ensuredWriteAccess.error.code === 'ProjectNotEnoughPermissions')
            return (0, result_1.err)(new authErrors_js_1.ProjectNotEnoughPermissionsError({
                message: "Your role on this project doesn't give you permission to load."
            }));
        return (0, result_1.err)(ensuredWriteAccess.error);
    }
    return (0, result_1.ok)();
};
exports.canLoadPolicy = canLoadPolicy;
const publiclyLoadableProjects = [
    '8be1007be1' // Demo models
];
//# sourceMappingURL=canLoad.js.map