"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.canReadAccIntegrationSettingsPolicy = void 0;
const result_1 = require("true-myth/result");
const authErrors_js_1 = require("../../domain/authErrors.js");
const projects_js_1 = require("../../fragments/projects.js");
const index_js_1 = require("../../../workspaces/index.js");
const canReadAccIntegrationSettingsPolicy = (loaders) => async ({ userId, projectId }) => {
    const env = await loaders.getEnv();
    const project = await loaders.getProject({ projectId });
    if (!env.FF_ACC_INTEGRATION_ENABLED || !project?.workspaceId) {
        return (0, result_1.err)(new authErrors_js_1.AccIntegrationNotEnabledError());
    }
    const ensuredProjectRole = await (0, projects_js_1.ensureImplicitProjectMemberWithReadAccessFragment)(loaders)({
        userId,
        projectId
    });
    if (ensuredProjectRole.isErr) {
        return (0, result_1.err)(ensuredProjectRole.error);
    }
    const workspacePlan = await loaders.getWorkspacePlan({
        workspaceId: project.workspaceId
    });
    if (!workspacePlan)
        return (0, result_1.err)(new authErrors_js_1.WorkspacePlanNoFeatureAccessError());
    const canUseFeature = (0, index_js_1.isWorkspaceFeatureFlagOn)({
        workspaceFeatureFlags: workspacePlan.featureFlags,
        feature: index_js_1.WorkspaceFeatureFlags.accIntegration
    });
    if (!canUseFeature)
        return (0, result_1.err)(new authErrors_js_1.WorkspacePlanNoFeatureAccessError());
    return (0, result_1.ok)();
};
exports.canReadAccIntegrationSettingsPolicy = canReadAccIntegrationSettingsPolicy;
//# sourceMappingURL=canReadAccIntegrationSettings.js.map